#!/usr/bin/perl

use Getopt::Long qw(:config no_ignore_case);
use Pod::Usage;

=pod

=head1 DESCRIPTION

    Convert peptide spectal matches to alignment file.

=head1 USAGE 

    generateSAM [options] -m <PSM> -f <.gtf> -t <transcript.fa> -p <protein.fa>

    Options:
    -m    Peptide spectral matches.
          - Generated by searchMS.pl
    -f    File name of gene annotation, .gtf format.
    -t    File name of transcript sequences, .fa format.
    -p    File name of protein sequences, .fa format.
    -o    Output folder. [Default: ./PASS_out]
    -h    Help message.

=head1 AUTHOR

    Contact:     Peng Wu; wupeng1@ihcams.ac.cn
    Last update: 2019-4-24

=cut

## Parsing arguments from command line
($psm, $genesgtf, $transcript, $protein, $outfolder, $help);

GetOptions(
	'm:s' => \$psm,
    'f:s' => \$genesgtf,
    't:s' => \$transcript,
    'p:s' => \$protein,
    'o:s' => \$outfolder,
    'h|help' => \$help
);

## Print usage  
pod2usage( { -verbose => 3, -output => \*STDERR } ) if ( $help );
( $psm and $genesgtf and $transcript and $protein) or pod2usage();


## Set default

$outfolder ||= "./PASS_out";
mkdir $outfolder;

$out = "$outfolder/PSM.sam";

`cp $genesgtf genesgtf_Rtmp`;
`cp $transcript transcript_Rtmp`;
`cp $protein protein_Rtmp`;
`cp $psm psm_Rtmp`;

open R_SCRIPT, '>', "generateSAM.R" or die $!;

print R_SCRIPT 
'if (!require("proBAMr")){
    source("http://bioconductor.org/biocLite.R")
    biocLite("proBAMr")
}
library("proBAMr")
gtfFile="genesgtf_Rtmp"
CDSfasta="transcript_Rtmp"
pepfasta="protein_Rtmp"
PrepareAnnotationGENCODE(gtfFile, CDSfasta, pepfasta,annotation_path="./", dbsnp=NULL,splice_matrix=FALSE, COSMIC=FALSE)

load("exon_anno.RData")
load("ids.RData")
load("proseq.RData")
load("procodingseq.RData")

passedPSM <- read.table("psm_Rtmp", sep="\t", header=TRUE)
SAM <- PSMtab2SAM(passedPSM, XScolumn="mvh", exon, proteinseq,procodingseq)
write.table(SAM, file="out_Rtmp", sep="\t", quote=FALSE, row.names=FALSE, col.names=FALSE)
';

`cat generateSAM.R | R --vanilla --slave`;
`cp out_Rtmp $out`;
`rm generateSAM.R txdb.sqlite exon_anno.RData ids.RData proseq.RData procodingseq.RData *_Rtmp`;
